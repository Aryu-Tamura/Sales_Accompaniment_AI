<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å–¶æ¥­ä¼´èµ°AI â€“ ãƒ‡ãƒ¢</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --surface:#f9fafb;
      --accent:#46B839;
      --accent-weak:rgba(70,184,57,0.12);
      --danger:#ef4444;
      --success:#16a34a;
      --warn-bg:#FEF3C7;
      --warn-bd:#FDE68A;
      --container-w:1200px;
      --blue: rgba(59,130,246,0.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:var(--bg);color:var(--text);} 
    a{color:inherit}

    /* Layout */
    .app{display:grid;grid-template-columns: 76px 1fr; min-height:100vh;}
    .sidebar{position:relative;background:#fff;border-right:1px solid var(--border);overflow:visible;width:76px;transition:width .2s ease;z-index:20}
    .sidebar:hover{width:260px;}
    .sidebar-inner{display:flex;flex-direction:column;height:100%;}
    .brand{display:flex;align-items:center;gap:.75rem;padding:1rem .75rem;border-bottom:1px solid var(--border);}
    .brand .logo{width:28px;height:28px;display:grid;place-items:center;border-radius:8px;background:var(--accent-weak);} 
    .brand .title{font-weight:700;white-space:nowrap;opacity:0;transform:translateX(-6px);transition:opacity .2s ease,transform .2s ease;}
    .sidebar:hover .brand .title{opacity:1;transform:none;}

    .nav{padding:.5rem .5rem;display:flex;flex-direction:column;gap:.25rem}
    .nav-btn{display:flex;align-items:center;gap:.75rem;border:0;background:transparent;padding:.625rem .5rem;border-radius:.6rem;color:var(--text);width:100%;cursor:pointer;}
    .nav-btn:hover{background:var(--surface);} 
    .nav-btn.active{background:var(--accent-weak); color:var(--accent);}
    .nav-btn .icon{min-width:28px;min-height:28px;display:grid;place-items:center}
    .nav-btn .label{white-space:nowrap;opacity:0;transform:translateX(-6px);transition:opacity .2s, transform .2s;}
    .sidebar:hover .nav-btn .label{opacity:1;transform:none;}
    .spacer{flex:1}
    .divider{height:1px;background:var(--border);margin:.25rem .5rem;}
    .user{display:flex;align-items:center;gap:.75rem;padding:.75rem .5rem}
    .user .avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:#fff;border:1px solid var(--border);}
    .user .meta{display:flex;flex-direction:column;min-width:0;opacity:0;transform:translateX(-6px);transition:opacity .2s, transform .2s;}
    .sidebar:hover .user .meta{opacity:1;transform:none;}
    .user .name{font-size:.9rem;font-weight:600}
    .user .email{font-size:.78rem;color:var(--muted)}

    .content{display:flex;flex-direction:column;min-width:0;}
    .container{max-width:var(--container-w);margin:0 auto;padding:0 clamp(16px,3vw,32px)}

    .page{display:none}
    .page.active{display:block}
    .page-inner{padding:1rem 0 2rem 0}

    .heading h2{font-size:1.6rem;margin:.2rem 0 .4rem 0}
    .heading p{color:var(--muted);margin:.2rem 0 .8rem 0}
    .hr{height:1px;background:var(--border);margin:.75rem 0 1rem 0}

    .filters{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:.8rem;align-items:center}
    .input, select{border:1px solid var(--border);background:#fff;border-radius:.6rem;padding:.55rem .7rem;font:inherit;}
    .btn{border:1px solid var(--border);background:#fff;border-radius:.6rem;padding:.55rem .8rem;font:inherit;cursor:pointer}
    .btn.primary{border-color:var(--accent);color:#fff;background:var(--accent);} 
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .chk{display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .5rem;border:1px solid var(--border);border-radius:.6rem;background:#fff}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .section{border:1px solid var(--border);border-radius:14px;background:#fff;padding:1rem}
    .section h3{margin:.2rem 0 .6rem 0}
    textarea{width:100%;min-height:160px;resize:vertical;border:1px solid var(--border);border-radius:.6rem;padding:.6rem;font:inherit;background:#fff}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}

    /* Kanban */
    .kanban-wrapper{overflow:auto;}
    /* â˜… ç¸¦é•·ã«ï¼ˆãƒ€ãƒŸãƒ¼æ¡ˆä»¶å¢—åŠ æ™‚ã§ã‚‚è¦–èªæ€§ï¼‰ */
    .kanban{display:flex;gap:1rem;min-height:760px;padding-bottom:1rem}
    .column{background:#fff;border:1px solid var(--border);border-radius:12px;min-width:280px;max-width:280px;display:flex;flex-direction:column}
    .column-header{padding:.75rem .9rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem;font-weight:600}
    .count{margin-left:auto;font-size:.8rem;color:var(--muted)}
    .cards{padding:.75rem;display:flex;flex-direction:column;gap:.75rem}
    .card{border:1px solid var(--border);border-radius:12px;background:#f9fafb;padding:.6rem .7rem;cursor:pointer}
    .card .title{font-weight:600;margin-bottom:.25rem}
    .chip{display:inline-flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.15rem .5rem;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--text)}
    .chip.warn{background:var(--warn-bg);border-color:var(--warn-bd)}
    .chip.big{background:var(--accent-weak);border-color:var(--accent)}

    /* Drawer */
    .drawer{position:fixed;inset:0;display:none;z-index:50}
    .drawer.open{display:block}
    .drawer .overlay{position:absolute;inset:0;background:rgba(0,0,0,.25)}
    .drawer .panel{position:absolute;right:0;top:0;height:100%;width:min(560px,92vw);background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 24px rgba(0,0,0,.08);display:flex;flex-direction:column}
    .drawer .panel .hd{display:flex;align-items:center;gap:.75rem;padding:1rem;border-bottom:1px solid var(--border)}
    .drawer .panel .bd{padding:1rem;overflow:auto;display:flex;flex-direction:column;gap:1rem}
    .meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .kv{display:flex;flex-direction:column;gap:.25rem}
    .kv .k{font-size:.85rem;color:var(--muted)}
    .kv .v{font-weight:600}
    .progress{height:10px;border:1px solid var(--border);border-radius:999px;background:#fff;overflow:hidden}
    .progress .bar{height:100%;width:0;background:var(--accent);}
    .progress-label{font-size:.9rem;color:var(--muted);}

    /* Tabs inside pages */
    .tabs{display:flex;gap:.5rem;margin-bottom:.6rem}
    .tab{border:1px solid var(--border);background:#fff;padding:.4rem .7rem;border-radius:.6rem;cursor:pointer}
    .tab.active{background:var(--accent-weak);border-color:var(--accent);color:var(--text)}

    /* Chat area */
    .chat-box{border:1px solid var(--border);border-radius:12px;background:#fff;height:280px;overflow:auto;padding:.75rem;display:flex;flex-direction:column;gap:.5rem}
    .msg{padding:.5rem .6rem;border-radius:.6rem;max-width:90%}
    .msg.user{align-self:flex-end;background:#e5f2ff;border:1px solid #cfe7ff}
    .msg.bot{align-self:flex-start;background:#f3f4f6;border:1px solid var(--border)}

    /* Overlay (busy lock) */
    .overlay{position:absolute;inset:0;background:rgba(255,255,255,.6);display:none;align-items:center;justify-content:center;border-radius:12px}
    .overlay.show{display:flex}
    .spinner{width:42px;height:42px;border:5px solid #ddd;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .relative{position:relative}

    /* Table (used minimal now) */
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid var(--border);padding:.7rem .8rem;text-align:left}
    th{background:#f9fafb;font-weight:700;color:#374151}

    /* Form: 1 column stack */
    .form-stack{display:flex;flex-direction:column;gap:.9rem}
    .field{display:flex;flex-direction:column;gap:.35rem}
    .field .label{font-size:.9rem;color:var(--muted)}
    .amount-row{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}

    /* Running steps (vertical) */
    .steps{display:flex;flex-direction:column;gap:.75rem}
    .step{border:1px solid var(--border);border-radius:12px;padding:.9rem;display:flex;align-items:center;gap:.75rem;background:#fff}
    .dot{width:12px;height:12px;border-radius:999px;background:#d1d5db}
    .step.done .dot{background:var(--accent)}

    /* â˜… è¿½åŠ ï¼šå®Ÿè¡Œä¸­ã®è¦–è¦šçŠ¶æ…‹ */
    .step.running .dot{
      background:#9ca3af;                /* å®Ÿè¡Œä¸­ã¯æ°´è‰² */
      box-shadow:0 0 0 3px rgba(147,197,253,.30) inset;
    }
    /* å³ç«¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¬„ã®å¹…ã‚’å®‰å®šã•ã›ã‚‹ */
    .step .sub{ min-width:72px; text-align:right; }


    .step .label{font-weight:600}
    .step .sub{margin-left:auto;color:var(--muted);font-size:.9rem}



    /* å³ç«¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¦‹ãŸç›®å¼·åŒ– */
    .step .sub{margin-left:auto;color:var(--muted);font-size:.9rem;display:flex;align-items:center;gap:.4rem}
    .lamp{width:12px;height:12px;border-radius:999px;background:#d1d5db;box-shadow:inset 0 0 0 1px #cbd5e1}
    .lamp.on{background:var(--success);box-shadow:0 0 0 3px rgba(22,163,74,.22), inset 0 0 0 1px #0f7a2a}
    .status{min-width:3.5em}

  

    /* === ã“ã“ã‹ã‚‰è¿½è¨˜ï¼šä¼šè©±ãƒ‡ãƒ¼ã‚¿ã®å¯èª­æ€§å‘ä¸Š === */
    /* ä¸€æ‹¬ã‚Šè¡¨ç¤ºã® <pre id="turns-pre"> ã‚’å¤§ãã‚ãƒ•ã‚©ãƒ³ãƒˆï¼†è¡Œé–“åºƒã‚ã« */
    #edit-tab-transcript #turns-pre{
      font-size: 1.1rem;
      line-height: 1.8;
      white-space: pre-wrap; /* æŠ˜ã‚Šè¿”ã— */
    }
    /* æ—§ç‰ˆã® #turns-list ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã®ä¿é™º */
    #edit-tab-transcript #turns-list{
      font-size: 1.1rem;
      line-height: 1.8;
    }
    /* æ ã®è¦‹ãŸç›®ï¼ˆä½¿ã„å›ã—ã‚¯ãƒ©ã‚¹ï¼‰ */
    .transcript-box{
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      padding: .9rem;
    }

    /* Minutes preview default size */
    #minutes-preview{min-height:600px}
  </style>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="ã‚µã‚¤ãƒ‰ãƒŠãƒ“">
      <div class="sidebar-inner">
        <div class="brand">
          <div class="logo">ğŸ·ï¸</div>
          <div class="title">å–¶æ¥­ä¼´èµ°AI</div>
        </div>
        <nav class="nav">
          <button class="nav-btn active" data-page="dashboard"><span class="icon">ğŸ“Š</span><span class="label">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span></button>
          <button class="nav-btn" data-page="performance"><span class="icon">ğŸ“ˆ</span><span class="label">æ¥­ç¸¾æ¯”è¼ƒ</span></button>
          <button class="nav-btn" data-page="minutes"><span class="icon">ğŸ“</span><span class="label">è­°äº‹éŒ²ä½œæˆ</span></button>
          <button class="nav-btn" data-page="reports"><span class="icon">ğŸ“…</span><span class="label">æ—¥å ±ãƒ»é€±å ±ç¢ºèª</span></button>
        </nav>
        <div class="spacer"></div>
        <div class="divider"></div>
        <div class="user">
          <div class="avatar">ğŸ‘¤</div>
          <div class="meta">
            <div class="name">ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
            <div class="email">user@example.com</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="content" id="main-content">
      <!-- Dashboard -->
      <section class="page active" id="page-dashboard">
        <div class="container">
          <div class="page-inner">
            <div class="heading">
              <h2>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
              <p>æ¡ˆä»¶ã”ã¨ã®é€²æ—çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆDBã‹ã‚‰å–å¾—ï¼‰ã€‚</p>
            </div>
            <div class="hr"></div>

            <div class="filters" aria-label="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
              <select id="filter-owner" class="input" aria-label="æ‹…å½“è€…ã§çµã‚Šè¾¼ã¿">
                <option value="">å…¨æ‹…å½“è€…</option>
                <option>ç”°ä¸­çœŸå¥ˆç¾</option>
                <option>æ¸¡è¾ºå¾¹</option>
                <option>å°æ—æ­å­</option>
                <option>å·¥è—¤å­¦</option>
                <option>å·¥è—¤æ–°ä¸€</option>
              </select>
              <label class="chk"><input type="checkbox" class="label-filter" value="è¦æ³¨æ„"> è¦æ³¨æ„</label>
              <label class="chk"><input type="checkbox" class="label-filter" value="å¤§å‹æ¡ˆä»¶"> å¤§å‹æ¡ˆä»¶</label>
              <div class="row" style="align-items:center">
                <span style="font-size:.9rem;color:var(--muted)">æ—¥ä»˜</span>
                <input type="date" id="filter-date-from" class="input" style="margin-left:.5rem"/>
                <span style="margin:0 .35rem">ã€œ</span>
                <input type="date" id="filter-date-to" class="input"/>
                <button id="filter-date-clear" class="btn" style="margin-left:.5rem">ã‚¯ãƒªã‚¢</button>
              </div>
            </div>

            <div id="kanban" class="kanban-wrapper">
              <div class="kanban" id="kanban-columns"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Performance -->
      <section class="page" id="page-performance">
        <div class="container">
          <div class="page-inner">
            <div class="heading">
              <h2>æ¥­ç¸¾æ¯”è¼ƒ</h2>
              <p>ä¼šç¤¾å…¨ä½“ã®å–¶æ¥­æ´»å‹•ã®å®Ÿç¸¾ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ã€‚</p>
            </div>
            <div class="hr"></div>

            <!-- KPI cardsï¼ˆ3æšã‚’æ¨ªä¸€åˆ—ã«ï¼‰ -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem">
              <div class="section">
                <h3>ä»Šæœˆã®å–æ‰±é¡åˆè¨ˆ</h3>
                <div id="kpi-amount" style="font-size:1.6rem;font-weight:800">Â¥ 214,000,000</div>
                <div id="kpi-amount-diff" style="color:var(--success);margin-top:.25rem">å‰æœˆæ¯” +7.3%</div>
              </div>
              <div class="section">
                <h3>ç›®æ¨™é”æˆç‡</h3>
                <div id="kpi-achv" style="font-size:1.6rem;font-weight:800">104%</div>
                <div style="color:var(--muted);margin-top:.25rem">ç›®æ¨™ã«å¯¾ã™ã‚‹é€²æ—</div>
              </div>
              <div class="section">
                <h3>èè³‡å®Ÿè¡Œä»¶æ•°</h3>
                <div id="kpi-count" style="font-size:1.6rem;font-weight:800">6ä»¶</div>
                <div style="color:#ef4444;margin-top:.25rem">å‰æœˆæ¯” -2ä»¶</div>
              </div>
            </div>

            <div class="section" style="margin-top:1rem">
              <h3>é€±ã”ã¨ã®å•†è«‡ä»¶æ•°ï¼ˆä»Šæœˆã€œéå»4ãƒ¶æœˆï¼‰</h3>
              <div id="weekly-bars" style="height:340px"></div>
            </div>

            <div class="section" style="margin-top:1rem">
              <h3>è£œè¶³èª¬æ˜</h3>
              <p style="margin:.3rem 0 0 0; color:var(--muted)">
                æœˆåˆ¥ãƒ»é€±åˆ¥ã§ã®å•†è«‡ä»¶æ•°ã®æ¨ç§»ã‚’å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚è–„ã„ç‚¹ç·šã¯é€±ã‚ãŸã‚Šã®ç›®æ¨™ä»¶æ•°ï¼ˆ50ä»¶ï¼‰ã§ã™ã€‚å®Ÿç¸¾ãŒç›®æ¨™ç·šã‚’ä¸Šå›ã‚‹é€±ã¯å„éƒ¨ã®æ–°è¦é–‹æ‹“ãŒå¥åŠŸã—ã€ä¸‹å›ã‚‹é€±ã¯æ—¢å­˜æ·±è€•ãŒä¸­å¿ƒã®å‚¾å‘ã§ã™ã€‚
              </p>
            </div>
          </div>
        </div>
      </section>


      <!-- Minutes -->
      <section class="page" id="page-minutes">
        <div class="container">
          <div class="page-inner">
            <div class="heading">
              <h2>è­°äº‹éŒ²ä½œæˆ</h2>
              <p>ä¼šè­°éŸ³å£°ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è­°äº‹éŒ²ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</p>
            </div>
            <div class="hr"></div>

            <!-- Step: input -->
            <div id="min-step-input" class="section">
              <h3>äº‹å‰æƒ…å ±ã®å…¥åŠ›</h3>

              <!-- å…¥åŠ›æ–¹æ³• -->
              <div class="section" style="margin-bottom:1rem">
                <div class="row">
                  <label class="chk"><input type="radio" name="inputMode" value="audio"> éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                  <label class="chk"><input type="radio" name="inputMode" value="text" checked> å•†è«‡ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥å…¥åŠ›</label>
                </div>
              </div>

              <!-- ç¸¦1åˆ—ãƒ•ã‚©ãƒ¼ãƒ  -->
              <div class="form-stack">
                <div class="field">
                  <div class="label">ä¼šç¤¾å</div>
                  <input id="i-company" class="input" placeholder="ä¾‹ï¼‰QRSç‰©æµ"/>
                </div>
                <div class="field">
                  <div class="label">å•†è«‡æ—¥</div>
                  <input id="i-date" type="date" class="input"/>
                </div>
                <div class="field">
                  <div class="label">ç›´å‰ã‚¹ãƒ†ãƒ¼ã‚¸</div>
                  <select id="i-prev-stage" class="input">
                    <option>ãƒªãƒ¼ãƒ‰</option><option selected>å•†è«‡</option><option>ææ¡ˆãƒ»æ¦‚ç®—æ¡ä»¶ã®æç¤º</option>
                    <option>ç”³è¾¼ãƒ»å¯©æŸ»</option><option>ç¨Ÿè­°æ›¸èªè¨¼</option><option>å¥‘ç´„æ‰‹ç¶šã</option><option>èè³‡å®Ÿè¡Œ</option><option>å¤±æ³¨</option>
                  </select>
                </div>
                <div class="field">
                  <div class="label">éŠ€è¡Œå´æ‹…å½“è€…</div>
                  <select id="i-owner-bank" class="input">
                    <option>ç”°ä¸­çœŸå¥ˆç¾</option><option>æ¸¡è¾ºå¾¹</option><option>å°æ—æ­å­</option><option>å·¥è—¤å­¦</option><option>å·¥è—¤æ–°ä¸€</option>
                  </select>
                </div>
                <div class="field">
                  <div class="label">é¡§å®¢å´æ‹…å½“è€…</div>
                  <input id="i-owner-client" class="input" placeholder="ä¾‹ï¼‰CFOä½ã€…æœ¨"/>
                </div>
                <div class="field">
                  <div class="label">å•†è«‡å›æ•°</div>
                  <input id="i-meetings" type="number" min="1" value="1" class="input" />
                </div>
                <div class="field">
                  <div class="label">å–æ‰±äºˆæƒ³é‡‘é¡</div>
                  <div class="amount-row">
                    <label class="chk"><input type="radio" name="amountMode" value="unset" checked> æœªå®š</label>
                    <label class="chk"><input type="radio" name="amountMode" value="set"> å…¥åŠ›ã™ã‚‹</label>
                    <input id="i-amount" type="number" min="0" class="input" placeholder="å††" style="display:none;width:200px"/>
                  </div>
                </div>
              </div>

              <!-- Audio or Text -->
              <div id="box-audio" class="section" style="margin-top:1rem; display:none">
                <h3>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <input id="i-audio" type="file" accept="audio/*" />
              </div>
              <div id="box-text" class="section" style="margin-top:1rem">
                <h3>å•†è«‡ãƒ†ã‚­ã‚¹ãƒˆ</h3>
                <textarea id="i-transcript" placeholder="[00:00:03] éŠ€è¡Œ: æœ¬æ—¥ã¯...&#10;[00:00:10] é¡§å®¢: æ¤œè¨ã—ã¦..."></textarea>
              </div>

              <div class="section" style="margin-top:1rem">
                <div class="row">
                  <button id="btn-gen" class="btn primary">è­°äº‹éŒ²ã‚’ç”Ÿæˆ</button>
                </div>
              </div>
            </div>

            <!-- Step: running (ç¸¦ä¸¦ã³) -->
            <div id="min-step-running" class="section" style="display:none">
              <div class="row">
                <button class="btn ghost" id="btn-back-to-input">â† æˆ»ã‚‹</button>
              </div>
              <h3>å‡¦ç†ä¸­</h3>
              <div class="steps">
                <div class="step" id="stp1">
                  <div class="dot"></div>
                  <div class="label">Step1ï¼šæ–‡å­—èµ·ã“ã—</div>
                  <div class="sub" id="stp1-sub">
                    <span class="spinner" id="stp1-spin" style="width:18px;height:18px;border-width:3px"></span>
                    <span class="status" id="stp1-status">å‡¦ç†ä¸­â€¦</span>
                    <span class="lamp" id="stp1-lamp" aria-hidden="true"></span>
                    </div>
                </div>

                <div class="step" id="stp2">
                  <div class="dot"></div>
                  <div class="label">Step2ï¼šè©±è€…åˆ†é›¢</div>
                  <div class="sub" id="stp2-sub">
                    <span class="spinner" id="stp2-spin" style="width:18px;height:18px;border-width:3px"></span>
                    <span class="status" id="stp2-status">å‡¦ç†ä¸­â€¦</span>
                    <span class="lamp" id="stp2-lamp" aria-hidden="true"></span>
                  </div>
                </div>

                <div class="step" id="stp3">
                  <div class="dot"></div>
                  <div class="label">Step3ï¼šè­°äº‹éŒ²ä½œæˆ</div>
                  <div class="sub" id="stp3-sub">
                    <span class="spinner" id="stp3-spin" style="width:18px;height:18px;border-width:3px"></span>
                    <span class="status" id="stp3-status">å‡¦ç†ä¸­â€¦</span>
                    <span class="lamp" id="stp3-lamp" aria-hidden="true"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step: edit -->
            <div id="min-step-edit" style="display:none">
              <div class="row" style="margin-bottom:.5rem; align-items:center">
                <button id="btn-go-analysis" class="btn" style="margin-left:auto; display:none">å•†è«‡åˆ†æã¸é€²ã‚€ â†’</button>
              </div>

              <div class="tabs">
                <div class="tab active" data-edit-tab="edit">è­°äº‹éŒ²ã®ç·¨é›†</div>
                <div class="tab" data-edit-tab="transcript">ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º</div>
              </div>

              <div id="edit-tab-edit">
                <div class="grid">
                  <!-- å·¦ï¼šã‚¹ãƒ†ãƒ¼ã‚¸ + æ ¹æ‹  + ãƒãƒ£ãƒƒãƒˆ -->
                  <div class="section relative">
                    <div class="overlay" id="lock-edit"><div class="spinner"></div></div>

                    <h3>ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã®ç¢ºèª</h3>
                    <div class="row" style="align-items:center">
                      <select id="sel-stage" class="input">
                        <!--<option>ãƒªãƒ¼ãƒ‰</option><option>å•†è«‡</option><option>ææ¡ˆãƒ»æ¦‚ç®—æ¡ä»¶ã®æç¤º</option> -->
                        <option>ç”³è¾¼ãƒ»å¯©æŸ»</option><option>ç¨Ÿè­°æ›¸èªè¨¼</option><option>å¥‘ç´„æ‰‹ç¶šã</option><option>èè³‡å®Ÿè¡Œ</option><option>å¤±æ³¨</option>
                      </select>
                    </div>

                    <div id="stage-proposal-box" style="margin-top:.5rem">
                      <div id="stage-prop-line" class="chip" style="background:#eef7ff;border-color:#cfe7ff">LLMææ¡ˆ: â€”</div>
                      <div id="stage-prop-why" style="color:var(--muted);margin-top:.3rem"></div>
                    </div>

                    <div id="stage-evidence" style="margin-top:.75rem; color:var(--muted)"></div>

                    <h3 style="margin-top:1rem">ãƒãƒ£ãƒƒãƒˆã§è­°äº‹éŒ²ã‚’ä¿®æ­£</h3>
                    <div class="chat-box" id="chat-box"></div>
                    <div class="row" style="margin-top:.5rem">
                      <input id="chat-input" class="input" placeholder="ä¾‹ï¼šæ±ºå®šäº‹é …ã«ç´æœŸåˆæ„ã‚’è¿½è¨˜ã—ã¦ãã ã•ã„" style="flex:1"/>
                      <button id="chat-send" class="btn">é€ä¿¡</button>
                    </div>
                  </div>

                  <!-- å³ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç›´æ¥ç·¨é›†å¯ï¼‰ -->
                  <div class="section relative" id="preview-panel">
                    <span class="chip saved-chip" id="chip-saved" style="display:none">ä¿å­˜æ¸ˆã¿</span>
                    <div class="overlay" id="lock-preview"><div class="spinner"></div></div>
                    <h3>è­°äº‹éŒ²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç›´æ¥ç·¨é›†å¯ï¼‰</h3>
                    <textarea id="minutes-preview"></textarea>
                    <div class="row" style="margin-top:.5rem">
                      <button id="btn-save-minutes" class="btn primary">ã“ã®è­°äº‹éŒ²ã§ä¿å­˜</button>
                      <a id="btn-download-docx" class="btn" href="#" target="_blank" style="display:none">Wordï¼ˆ.docxï¼‰ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
                    </div>

                  </div>
                </div>
              </div>

              <div id="edit-tab-transcript" style="display:none">
                <div class="section">
                  <h3>ä¼šè©±ãƒ‡ãƒ¼ã‚¿ï¼ˆè©±è€…åˆ†é›¢æ¸ˆã¿ï¼‰</h3>
                  <!-- â˜… ä¸€æ‹¬æ ã§è¡¨ç¤º -->
                  <pre id="turns-pre" class="transcript-box">ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰</pre>
                </div>
              </div>
            </div>

            <!-- Step: analysis -->
            <div id="min-step-analysis" style="display:none">
              <div class="row" style="margin-bottom:.5rem; align-items:center">
                <button class="btn ghost" id="btn-back-to-edit">â† æˆ»ã‚‹</button>
                <button class="btn" id="btn-new-minutes" style="margin-left:auto">ï¼‹ æ–°ã—ã„è­°äº‹éŒ²ã‚’ä½œæˆ</button>

              </div>
              <div class="tabs">
                <div class="tab active" data-ana-tab="risks">ãƒªã‚¹ã‚¯æ¨å®š</div>
                <div class="tab" data-ana-tab="coach">æ‹…å½“è€…ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
              </div>

              <div id="ana-tab-risks">
                <div class="section">
                  <h3>ä¸Šå¸ã¸ã®å ±å‘Š</h3>
                  <div id="manager-report" style="white-space:pre-wrap"></div>
                </div>
                <div class="section">
                  <h3>ãƒªã‚¹ã‚¯ä¸€è¦§
                    <span id="risk-label-suggest" class="chip warn" style="display:none;margin-left:.5rem">è¦æ³¨æ„ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸</span>
                  </h3>
                  <div id="risk-list"></div>
                </div>
              </div>

              <div id="ana-tab-coach" style="display:none">
                <div class="section">
                  <h3>ä¼šè©±ãƒãƒ©ãƒ³ã‚¹</h3>
                  <div class="row" style="align-items:center; justify-content:center">
                    <div id="pie" style="width:420px; max-width:100%; height:320px; margin:0 auto"></div>
                  </div>
                  <div id="coach-msg" style="margin-top:.25rem"></div>
                </div>
                <!-- â˜…â˜…â˜… ãƒ•ã‚§ãƒ¼ã‚ºã«åŸºã¥ãTipsï¼šã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ #ana-tab-coach ã®æœ«å°¾ã«è¿½è¨˜ â˜…â˜…â˜… -->
                <div class="section" style="margin-top:1rem">
                  <h3>ãƒ•ã‚§ãƒ¼ã‚ºã«åŸºã¥ãã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
                  <div id="phase-tips" style="white-space:pre-wrap"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Reports -->
      <section class="page" id="page-reports">
        <div class="container">
          <div class="page-inner">
            <div class="heading">
              <h2>æ—¥å ±ãƒ»é€±å ±ç¢ºèª</h2>
              <p>å–¶æ¥­æ´»å‹•å…¨ä½“ã®æ—¥å ±ãƒ»é€±å ±ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆãƒ€ãƒŸãƒ¼è¡¨ç¤ºï¼‰ã€‚</p>
            </div>
            <div class="hr"></div>

            <!-- æ—¥å ±ï¼ˆç¸¦ä¸¦ã³ã‚«ãƒ¼ãƒ‰ï¼‰ -->
            <div class="section">
              <h3>éå»ã®æ—¥å ±</h3>
              <div style="display:flex;flex-direction:column;gap:.8rem">
                <div style="border:1px solid var(--border);border-radius:12px;padding:.8rem">
                  <div style="font-size:1.1rem;font-weight:800">8/24 ã®å•†è«‡æ•°ï¼š14ä»¶</div>
                  <div style="margin-top:.4rem">QRSç‰©æµã¨æ¡ä»¶ã®æ“¦ã‚Šåˆã‚ã›ã€‚æ¬¡å›ææ¡ˆã«å‘ã‘ã€å¿…è¦æ›¸é¡ã®ç¢ºèªã‚’å®Ÿæ–½ã€‚</div>
                </div>
                <div style="border:1px solid var(--border);border-radius:12px;padding:.8rem">
                  <div style="font-size:1.1rem;font-weight:800">8/23 ã®å•†è«‡æ•°ï¼š9ä»¶</div>
                  <div style="margin-top:.4rem">å±±ç”°å•†ä¼šã®ç´¹ä»‹å¯¾å¿œã€‚åˆå›é¢è«‡ã‚’æ¥é€±ã«è¨­å®šã€è¦ä»¶ã®äº‹å‰ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚’å®Ÿæ–½ã€‚</div>
                </div>
              </div>
            </div>

            <!-- é€±å ±ï¼ˆç¸¦ä¸¦ã³ã‚«ãƒ¼ãƒ‰ï¼‰ -->
            <div class="section" style="margin-top:1rem">
              <h3>éå»ã®é€±å ±</h3>
              <div style="display:flex;flex-direction:column;gap:.8rem">
                <div style="border:1px solid var(--border);border-radius:12px;padding:.8rem">
                  <div style="font-size:1.1rem;font-weight:800">8æœˆ ç¬¬3é€±ã®å•†è«‡æ•°ï¼š62ä»¶ <span style="color:var(--success);font-weight:700;margin-left:.4rem">+8ä»¶</span></div>
                  <div style="margin-top:.4rem">æ–°è¦é–‹æ‹“ãŒå¢—åŠ ã—ã€æ—¢å­˜æ·±è€•ã‚‚å …èª¿ã€‚æ¥é€±ã¯é¢è«‡ã®æ±ºè£è€…åŒå¸­ç‡ã‚’ä¸Šã’ã‚‹æ–¹é‡ã€‚</div>
                </div>
                <div style="border:1px solid var(--border);border-radius:12px;padding:.8rem">
                  <div style="font-size:1.1rem;font-weight:800">8æœˆ ç¬¬2é€±ã®å•†è«‡æ•°ï¼š54ä»¶ <span style="color:#ef4444;font-weight:700;margin-left:.4rem">-5ä»¶</span></div>
                  <div style="margin-top:.4rem">å¤§å‹å•†è«‡ã®ç¨Ÿè­°å‰å¯¾å¿œãŒä¸­å¿ƒã€‚æ–°è¦ã¯ã‚„ã‚„æ¸›ã€CFO ãƒ¬ãƒ™ãƒ«ã¨ã®æ¥ç‚¹å¼·åŒ–ã‚’ç¶™ç¶šã€‚</div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Drawer: æ¡ˆä»¶è©³ç´° -->
  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="overlay" id="drawer-overlay"></div>
    <div class="panel" role="dialog" aria-modal="true">
      <div class="hd">
        <button class="btn" id="drawer-close" aria-label="é–‰ã˜ã‚‹">âœ•</button>
        <h3 id="drawer-title">æ¡ˆä»¶è©³ç´°</h3>
      </div>
      <div class="bd">
        <div class="meta-grid">
          <div class="kv"><div class="k">ç¤¾å</div><div class="v" id="d-company">â€”</div></div>
          <div class="kv"><div class="k">äºˆå®šå–æ‰±é¡</div><div class="v" id="d-amount">â€”</div></div>
          <div class="kv"><div class="k">ç›´è¿‘ã®å•†è«‡æ—¥</div><div class="v" id="d-start">â€”</div></div>
          <div class="kv"><div class="k">æ‹…å½“</div><div class="v" id="d-owner">â€”</div></div>
        </div>
        <div class="kv"><div class="k">ä¸ä¿¡çŠ¶æ³</div><div class="v" id="d-credit">â€”</div></div>
        <div class="kv"><div class="k">é–¢ä¿‚è€…</div><div class="v" id="d-stakeholders">â€”</div></div>
        <div class="section">
          <h3>ä½œæ¥­é€²æ—</h3>
          <div class="progress"><div class="bar" id="d-progress-bar"></div></div>
          <div class="progress-label" id="d-progress-label">â€”</div>
        </div>
        <details>
          <summary>éå»ã®è­°äº‹éŒ²</summary>
          <div id="d-past-minutes" style="margin-top:.5rem;display:flex;flex-direction:column;gap:.5rem"></div>
        </details>
        <details>
          <summary>ä»Šå¾Œã®äºˆå®š</summary>
          <ul id="d-schedules" style="margin:.6rem 0 0 1rem;padding:0 0 0 1rem"></ul>
        </details>
        <!-- â˜… è¿½åŠ ï¼šä¸Šå¸ã¸ã®å ±å‘Šï¼ˆæœ€æ–°ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‹ã‚‰å–å¾—ï¼‰ -->
        <details>
          <summary>ä¸Šå¸ã¸ã®å ±å‘Š</summary>
          <div id="d-manager-report" style="white-space:pre-wrap;margin-top:.5rem;color:#111"></div>
          <div id="d-risk-list" style="margin-top:.75rem"></div>
        </details>
      </div>
    </div>
  </div>

  <script>
    // -------------------- helpers --------------------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const api = {
      get: (url) => fetch(url).then(r => r.ok ? r.json() : r.text().then(t=>{throw new Error(t)})),
      postJSON: (url, body) => fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r => r.ok ? r.json() : r.text().then(t=>{throw new Error(t)})),
      postForm: (url, formData) => fetch(url,{method:'POST',body:formData}).then(r => r.ok ? r.json() : r.text().then(t=>{throw new Error(t)})),
    };

    const STAGES = ["ãƒªãƒ¼ãƒ‰","å•†è«‡","ææ¡ˆãƒ»æ¦‚ç®—æ¡ä»¶ã®æç¤º","ç”³è¾¼ãƒ»å¯©æŸ»","ç¨Ÿè­°æ›¸èªè¨¼","å¥‘ç´„æ‰‹ç¶šã","èè³‡å®Ÿè¡Œ","å¤±æ³¨"];

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã¯ã€Œãƒªãƒ¼ãƒ‰ã€ã‚’é™¤å¤–ã—ã¦è¡¨ç¤º
    const DASHBOARD_STAGES = STAGES.filter(s => s !== "ãƒªãƒ¼ãƒ‰");


    // â˜… è¿½åŠ ï¼šã‚¹ãƒ†ãƒ¼ã‚¸åã®æ­£è¦åŒ–ï¼ˆå€™è£œâ†’å¿…ãš STAGES ã®ã©ã‚Œã‹1ã¤ï¼‰
    function coerceToValidStage(to, fallback){
      const TRIM = s => String(s||"").replace(/\s+/g,"").trim();
      const ALIAS = {
        "ææ¡ˆ": "ææ¡ˆãƒ»æ¦‚ç®—æ¡ä»¶ã®æç¤º",
        "æ¦‚ç®—æ¡ä»¶æç¤º": "ææ¡ˆãƒ»æ¦‚ç®—æ¡ä»¶ã®æç¤º",
        "ææ¡ˆæ¡ä»¶æç¤º": "ææ¡ˆãƒ»æ¦‚ç®—æ¡ä»¶ã®æç¤º",
        "ç”³è¾¼": "ç”³è¾¼ãƒ»å¯©æŸ»",
        "å¯©æŸ»": "ç”³è¾¼ãƒ»å¯©æŸ»",
        "ç¨Ÿè­°": "ç¨Ÿè­°æ›¸èªè¨¼",
        "å¥‘ç´„": "å¥‘ç´„æ‰‹ç¶šã",
        "å®Ÿè¡Œ": "èè³‡å®Ÿè¡Œ",
      };

      let t = TRIM(to);
      if (!t) return fallback || "å•†è«‡";
      if (STAGES.includes(t)) return t;
      if (ALIAS[t]) return ALIAS[t];

      // â€œææ¡ˆãƒ»æ¦‚ç®—â€¦â€ ã®ä¸€éƒ¨ã ã‘ãªã©æ›–æ˜§å…¥åŠ›ã®æ•‘æ¸ˆ
      for (const v of STAGES){
        if (TRIM(v) === t || v.includes(to) || t.includes(v)) return v;
      }
      return fallback || "å•†è«‡";
    }



    const state = {
      // dashboard
      filterOwner: "",
      filterLabels: new Set(),
      filterDateFrom: null,
      filterDateTo: null,
      columns: {},

      // minutes flow
      minutesStep: "input", // input | running | edit | analysis
      inputMode: "text",    // audio | text
      amountMode: "unset",  // unset | set

      // context
      ctx: {
        company: "", meeting_date: "", prev_stage:"å•†è«‡",
        owner_bank:"ç”°ä¸­çœŸå¥ˆç¾", owner_client:"", meetings_count:1, amount: null
      },

      // ids
      meetingId: null,

      // generation results
      turns: [],
      evidence: null, infer: null, narratives: null,
      coach_feedback: "", // â˜… è¿½åŠ 


      // edit
      stageSelected: "å•†è«‡",
      minutes_draft: "",
      manager_report: "",
      risks: [],

      // save
      docxUrl: "", pdfUrl: ""
    };

    function setPage(name){
      $$(".page").forEach(p=>p.classList.remove("active"));
      $("#page-"+name).classList.add("active");
      $$(".nav-btn").forEach(b=>b.classList.toggle("active", b.dataset.page===name));
      if (name==="performance") renderPerformance();
    }

    // -------------------- dashboard --------------------
    async function loadDashboard(){
      const params = new URLSearchParams();
      if (state.filterOwner) params.set("owner", state.filterOwner);
      if (state.filterLabels.size){
        params.set("labels", Array.from(state.filterLabels).join(","));
      }
      const data = await api.get("/api/dashboard/list"+(params.toString()?`?${params.toString()}`:""));
      state.columns = data.columns || {};
      renderKanban();
    }

    function renderKanban(){
      const kc = $("#kanban-columns");
      kc.innerHTML = "";
      for (const stage of DASHBOARD_STAGES){
        const items = (state.columns[stage] || []).filter(itemMatchesDate);
        const col = document.createElement("div");
        col.className = "column";
        col.innerHTML = `
          <div class="column-header">${stage} <span class="count">${items.length}</span></div>
          <div class="cards"></div>
        `;
        const cards = col.querySelector(".cards");
        for (const it of items){
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.dealId = it.deal_id;
          card.innerHTML = `
            <div class="title">${it.company}</div>
            <div class="row">
              ${it.owner?`<span class="chip">æ‹…å½“: ${it.owner}</span>`:""}
              ${it.meeting_date?`<span class="chip">æ—¥ä»˜: ${it.meeting_date}</span>`:""}
              ${Array.isArray(it.labels)? it.labels.map(l=>`<span class="chip ${l==='è¦æ³¨æ„'?'warn':''} ${l==='å¤§å‹æ¡ˆä»¶'?'big':''}">${l}</span>`).join(""):""}
            </div>
          `;
          card.addEventListener("click", ()=> openDrawer(it.deal_id));
          cards.appendChild(card);
        }
        kc.appendChild(col);
      }
    }

    function itemMatchesDate(it){
      // ã‚«ãƒ¼ãƒ‰ã«å‡ºã—ã¦ã„ã‚‹ meeting_date ã‚’æœ€å„ªå…ˆã§ä½¿ã†ã€‚ä»–ã®å€™è£œãŒã‚ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      const ds = it.meeting_date || it.date || it.start_date || (it.deal && it.deal.start_date);
      if (!ds) return true; // æ—¥ä»˜ãŒç„¡ã„ã‚‚ã®ã¯ä¸€æ—¦è¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰ false ã§ã‚‚OKï¼‰

      // "YYYY-MM-DD" ã¾ãŸã¯ ISO æ–‡å­—åˆ—ã«å¯¾å¿œ
      const d = new Date(ds.length <= 10 ? (ds + "T00:00:00") : ds);

      if (state.filterDateFrom && d < state.filterDateFrom) return false;
      if (state.filterDateTo && d > state.filterDateTo) return false;
      return true;
    }


    async function openDrawer(dealId){
      try{
        const d = await api.get(`/api/deals/${dealId}`);
        $("#drawer-title").textContent = "æ¡ˆä»¶è©³ç´°";
        $("#d-company").textContent = d.company || d.deal?.company || "â€”";
        const amount = (d.amount ?? d.deal?.amount);
        $("#d-amount").textContent = (amount!=null)?`Â¥ ${Number(amount).toLocaleString()}`:"â€”";
        // ç›´è¿‘ã®å•†è«‡æ—¥ = past_minutesã®æœ€ä¸Šä½ or start_date
        // ç›´è¿‘ã®å•†è«‡æ—¥ï¼šã‚µãƒ¼ãƒè¨ˆç®—ã® recent_meeting_date ã‚’å„ªå…ˆ
        const recent = d.recent_meeting_date || ((d.past_minutes && d.past_minutes.length) ? d.past_minutes[0].created_at : (d.start_date || d.deal?.start_date));
        $("#d-start").textContent = recent || "â€”";

        $("#d-owner").textContent = d.owner || d.deal?.owner || "â€”";
        const creditObj = d.credit || d.deal?.credit || {};
        $("#d-credit").textContent = Object.keys(creditObj).length ? Object.entries(creditObj).map(([k,v])=>`${k}${v?` ${v}`:""}`).join(" / ") : "â€”";
        const stakeholders = d.stakeholders || d.deal?.stakeholders || [];
        $("#d-stakeholders").innerHTML = (stakeholders.length ? stakeholders.map(s=>`<span class="chip">${s}</span>`).join(" ") : "â€”");

        const p = d.progress_pct ?? d.deal?.progress_pct ?? 0;
        $("#d-progress-bar").style.width = p + "%";
        const stageLabel = d.stage || d.deal?.stage || "â€”";
        $("#d-progress-label").textContent = p===100 ? "å®Œäº†ï¼ˆèè³‡å®Ÿè¡Œï¼‰" : `é€²æ—: ${p}% ï¼ ã‚¹ãƒ†ãƒ¼ã‚¸: ${stageLabel}`;

        const pm = $("#d-past-minutes");
        pm.innerHTML = (d.past_minutes||[]).length
          ? d.past_minutes.map(m=>`<div style="padding:.5rem;border:1px solid var(--border);border-radius:10px">
              <div style="color:var(--muted);font-size:.85rem">${m.created_at||""}</div>
              <div>${(m.excerpt||"").slice(0,80)}...</div>
            </div>`).join("")
          : "ï¼ˆãªã—ï¼‰";

        const sc = $("#d-schedules");
        const schedules = d.schedules || d.schedule || d.deal?.schedule || [];
        sc.innerHTML = schedules.map(s=>`<li>${s.date?`${s.date}ï¼š`:``}${s.text || s.item_text || s}</li>`).join("");

        // ä¸Šå¸ã¸ã®å ±å‘Š & ãƒªã‚¹ã‚¯ï¼ˆæœ€æ–° meeting_id ãŒã‚ã‚Œã°å–å¾—ï¼‰
        $("#d-manager-report").textContent = "";
        $("#d-risk-list").innerHTML = "";
        const latestMid = (d.past_minutes && d.past_minutes.length) ? d.past_minutes[0].meeting_id : null;
        if (latestMid){
          const ana = await api.get(`/api/analysis/risks?meeting_id=${encodeURIComponent(latestMid)}`).catch(()=>null);
          if (ana){
            $("#d-manager-report").textContent = ana.manager_report || "ï¼ˆå ±å‘Šãªã—ï¼‰";
            $("#d-risk-list").innerHTML = (ana.risks||[]).map(r=>`
              <div style="border:1px solid var(--border);border-radius:10px;padding:.6rem;margin:.4rem 0">
                <div><b>[${r.severity||""}] ${r.category||""}</b></div>
                ${r.evidence_span? `<pre style="white-space:pre-wrap;background:#f9fafb;border:1px solid var(--border);padding:.45rem;border-radius:8px;margin-top:.4rem">${escapeHtml(r.evidence_span)}</pre>`:""}
              </div>
            `).join("");
          }
        }

        $("#drawer").classList.add("open");
        $("#drawer").setAttribute("aria-hidden","false");
        enableOutsideCloseSoon(); // â† åŒä¸€ã‚¯ãƒªãƒƒã‚¯ã§å³é–‰ã˜ãªã„ãŸã‚ã®ãƒ‡ã‚£ãƒ¬ã‚¤æœ‰åŠ¹åŒ–
      }catch(e){
        alert("è©³ç´°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e);
      }
    }
    function closeDrawer(){
      $("#drawer").classList.remove("open");
      $("#drawer").setAttribute("aria-hidden","true");
    }

    // === ãƒ‰ãƒ­ãƒ¯ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆå®‰å…¨ç‰ˆï¼‰ ===
    const drawerEl = document.getElementById("drawer");
    const drawerPanelEl = drawerEl.querySelector(".panel");
    let allowOutsideClose = false;

    function enableOutsideCloseSoon() {
      allowOutsideClose = false;
      setTimeout(() => { allowOutsideClose = true; }, 0);
    }

    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ / Ã— ãƒœã‚¿ãƒ³ / Esc ã§é–‰ã˜ã‚‹
    $("#drawer-overlay").addEventListener("click", closeDrawer);
    $("#drawer-close").addEventListener("click", closeDrawer);
    document.addEventListener("keydown", e=>{ if(e.key==='Escape') closeDrawer(); });

    // ãƒ‘ãƒãƒ«å†…ã‚¯ãƒªãƒƒã‚¯ã¯ãƒãƒ–ãƒªãƒ³ã‚°åœæ­¢ï¼ˆå¤–å´æ‰±ã„ã«ã•ã›ãªã„ä¿é™ºï¼‰
    drawerPanelEl.addEventListener("click", (e) => e.stopPropagation());

    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã©ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ã€ãƒ‘ãƒãƒ«å¤–ãªã‚‰é–‰ã˜ã‚‹
    document.addEventListener("click", (e) => {
      if (!drawerEl.classList.contains("open") || !allowOutsideClose) return;
      if (drawerPanelEl.contains(e.target)) return; // å†…å´ã¯ç„¡è¦–
      closeDrawer();
    });

    // filters
    $("#filter-owner").addEventListener("change", ()=>{
      state.filterOwner = $("#filter-owner").value;
      loadDashboard();
    });
    $$(".label-filter").forEach(ch=>{
      ch.addEventListener("change", ()=>{
        if (ch.checked) state.filterLabels.add(ch.value); else state.filterLabels.delete(ch.value);
        loadDashboard();
      });
    });

    // date filters
    const elFrom = document.getElementById("filter-date-from");
    const elTo   = document.getElementById("filter-date-to");
    const elClr  = document.getElementById("filter-date-clear");

    if (elFrom) elFrom.addEventListener("change", ()=>{
      state.filterDateFrom = elFrom.value ? new Date(elFrom.value + "T00:00:00") : null;
      renderKanban(); // å–å¾—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦å‰æ®µã§çµã‚Šè¾¼ã‚€
    });
    if (elTo) elTo.addEventListener("change", ()=>{
      state.filterDateTo = elTo.value ? new Date(elTo.value + "T23:59:59") : null;
      renderKanban();
    });
    if (elClr) elClr.addEventListener("click", ()=>{
      elFrom.value = ""; elTo.value = "";
      state.filterDateFrom = null; state.filterDateTo = null;
      renderKanban();
    });



    // -------------------- minutes: inputs --------------------
    // input mode switch
    $$("input[name='inputMode']").forEach(r=>{
      r.addEventListener("change", ()=>{
        state.inputMode = r.value;
        $("#box-audio").style.display = (state.inputMode==='audio')?"block":"none";
        $("#box-text").style.display = (state.inputMode==='text')?"block":"none";
      });
    });
    // amount mode
    $$("input[name='amountMode']").forEach(r=>{
      r.addEventListener("change", ()=>{
        state.amountMode = r.value;
        $("#i-amount").style.display = (state.amountMode==='set')?"block":"none";
      });
    });

function setStepStatus(n, status){
  const el = $(`#stp${n}`);
  el.classList.remove("done","running");
  if (status === "done"){
    el.classList.add("done");
    $(`#stp${n}-sub`).textContent = "å®Œäº†";
  }else if (status === "running"){
    el.classList.add("running");
    $(`#stp${n}-sub`).innerHTML = `<span class="spinner" style="width:18px;height:18px;border-width:3px"></span>`;
  }else{
    $(`#stp${n}-sub`).textContent = "â€”";
  }
}
function markStepSpin(n){
  [1,2,3].forEach(i=>{ $(`#stp${i}`).classList.remove("running"); });
  setStepStatus(n, "running");
}
function markStepDone(n){
  setStepStatus(n, "done");
}


    // generate minutes
    $("#btn-gen").addEventListener("click", async ()=>{
      // collect context
      const ctx = state.ctx;
      ctx.company = $("#i-company").value.trim();
      ctx.meeting_date = $("#i-date").value;
      ctx.prev_stage = $("#i-prev-stage").value;
      ctx.owner_bank = $("#i-owner-bank").value;
      ctx.owner_client = $("#i-owner-client").value.trim();
      ctx.meetings_count = parseInt($("#i-meetings").value||"1",10);
      ctx.amount = (state.amountMode==='set') ? (Number($("#i-amount").value)||0) : null;
    
      if (!ctx.company || !ctx.meeting_date || !ctx.owner_client){
        alert("ä¼šç¤¾åãƒ»å•†è«‡æ—¥ãƒ»é¡§å®¢å´æ‹…å½“è€…ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }
    
      // â˜… æ–°è¦ç”Ÿæˆã®è¦‹ãŸç›®åˆæœŸåŒ–ï¼ˆ2ä»¶ç›®ä»¥é™ã®æ®‹åƒã‚’æ¶ˆã™ï¼‰
      const go   = $("#btn-go-analysis");   if (go)   go.style.display = "none";
      const docx = $("#btn-download-docx"); if (docx) docx.style.display = "none";
      const saved= $("#chip-saved");        if (saved) saved.style.display = "none";
      $("#chat-box").innerHTML = "";
      $("#minutes-preview").value = "";
      $("#turns-pre").textContent = "ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";
    
      // go running viewï¼ˆç¸¦ä¸¦ã³ï¼‰
      state.minutesStep = "running";
      updateMinutesView();
    
      // textå…¥åŠ›æ™‚ã¯ Step1/2ã¯å®Ÿæ–½æ¸ˆè¡¨ç¤ºã€Step3ã®ã¿ã‚¹ãƒ”ãƒ³
      if (state.inputMode==='text'){
        markStepDone(1);
        markStepDone(2);
        markStepSpin(3);
      }else{
        markStepSpin(1);
        // 2 ã¨ 3 ã¯ç©ºã«ï¼ˆãƒ©ãƒ³ãƒ—ã¯ã‚°ãƒ¬ãƒ¼ã®ã¾ã¾ï¼‰
        $("#stp2").classList.remove("done","running"); $("#stp2-sub").textContent = "";
        $("#stp3").classList.remove("done","running"); $("#stp3-sub").textContent = "";
      }
    
      try{
        let res;
        if (state.inputMode==='audio'){
          const f = $("#i-audio").files[0];
          if (!f){ alert("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
          const fd = new FormData();
          fd.append("company", ctx.company);
          fd.append("meeting_date", ctx.meeting_date);
          fd.append("prev_stage", ctx.prev_stage);
          fd.append("owner_bank", ctx.owner_bank);
          fd.append("owner_client", ctx.owner_client);
          fd.append("meetings_count", String(ctx.meetings_count));
          if (ctx.amount!=null) fd.append("amount", String(ctx.amount));
          fd.append("audio", f);
          res = await api.postForm("/api/minutes/run_audio", fd);
          markStepDone(1); markStepDone(2); markStepSpin(3);
        }else{
          const text = $("#i-transcript").value;
          if (!text.trim()){ alert("å•†è«‡ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
          const payload = {
            company: ctx.company,
            meeting_date: ctx.meeting_date,
            prev_stage: ctx.prev_stage,
            amount: ctx.amount,
            owner_bank: ctx.owner_bank,
            owner_client: ctx.owner_client,
            meetings_count: ctx.meetings_count,
            transcript_text: text,
            minutes_hint: ""
          };
          res = await api.postJSON("/api/minutes/run_text", payload);
        }
    
        // store ids/results
        state.meetingId = res.meeting_id || null;
        state.evidence = res.evidence || null;
        state.infer = res.infer || null;
        state.narratives = res.narratives || null;
        // â˜… è¿½åŠ ï¼šLLMã‚³ãƒ¼ãƒãƒ³ã‚°æ–‡
        state.coach_feedback = (res.coach_feedback || "").trim();
    
        // ã‚¹ãƒ†ãƒ¼ã‚¸æ—¢å®šå€¤
        const stObj = state.infer?.suggested_changes?.stage || null;
        const proposed = (stObj && stObj.to) || ctx.prev_stage;
        state.stageSelected = coerceToValidStage(proposed, ctx.prev_stage);
        $("#sel-stage").value = state.stageSelected;
    
        // æ ¹æ‹ ï¼†ææ¡ˆ
        renderStageEvidence();
        renderStageProposal();
    
        // ä¼šè©±ãƒ‡ãƒ¼ã‚¿
        await loadTurns(state.meetingId);
    
        // minutes é¢
        state.minutes_draft  = state.narratives?.minutes_draft || "";
        state.manager_report = state.narratives?.manager_report_draft || "";
        state.risks = state.infer?.risks || [];
    
        // å®Œäº†
        markStepDone(3);
    
        // ç·¨é›†ã¸
        state.minutesStep = "edit";
        updateMinutesView();
      }catch(e){
        alert("ç”ŸæˆAPIå¤±æ•—: " + e.message);
        state.minutesStep = "input";
        updateMinutesView();
      }
    });


    async function loadTurns(meetingId){
      if (!meetingId){ $("#turns-pre").textContent = "ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰"; return; }
      const t = await api.get(`/api/meetings/turns?meeting_id=${encodeURIComponent(meetingId)}`);
      state.turns = t.turns || [];
      if (!state.turns.length){ $("#turns-pre").textContent = "ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰"; return; }
      const lines = state.turns.map(tt=>{
        const at = secToMMSS(tt.start);
        const sp = tt.speaker_name || tt.speaker_label || "";
        return `[${at}] ${sp}: ${tt.text||""}`;
      }).join("\n");
      $("#turns-pre").textContent = lines;
    }

    function secToMMSS(s){
      const m = Math.floor(s/60), ss = Math.floor(s%60);
      return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }

    // tabs edit / transcript
    $$(".tab[data-edit-tab]").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        $$(".tab[data-edit-tab]").forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        const key = tab.dataset.editTab;
        $("#edit-tab-edit").style.display = (key==="edit")?"block":"none";
        $("#edit-tab-transcript").style.display = (key==="edit")?"none":"block";
      });
    });

    function renderStageEvidence(){
      const e = state.infer?.stage_change_evidence || [];
      if (!e.length){ $("#stage-evidence").innerHTML = "ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã®æ ¹æ‹ ãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰"; return; }
      $("#stage-evidence").innerHTML = `
        <div style="font-weight:600;color:#111;margin-bottom:.2rem">æ ¹æ‹ </div>
        ${e.map(x=>`<div style="border-left:3px solid var(--accent);padding:.35rem .5rem;margin:.35rem 0;background:#f9fafb;border-radius:6px">
          <div style="color:var(--muted);font-size:.85rem">${x.at||""} ï½œ <b>${x.speaker||""}</b></div>
          <div>${escapeHtml(x.quote||"")}</div>
        </div>`).join("")}
      `;
    }
    function renderStageProposal(){
      const st = state.infer?.suggested_changes?.stage || null;
      const from = state.ctx?.prev_stage || "â€”";
      // æ—¢ã« state.stageSelected ã¯åˆæœŸåŒ–æ™‚ã«ææ¡ˆ to ã‚’ã‚»ãƒƒãƒˆæ¸ˆã¿
      const toRaw = st?.to || state.stageSelected || from;

      // ã€ŒåŒã˜ã€ã‚’æ˜ç¤ºè¡¨ç¾ï¼ˆå•†è«‡ â†’ åŒã˜ï¼‰
      const isSame = (toRaw === from);
      const to = isSame ? "åŒã˜" : toRaw;

      // ç¢ºåº¦ã¯ 0.0ã€œ1.0 å‰æã§ % ã«ï¼ˆ0ã€œ100 ã®å ´åˆã«å‚™ãˆã¦äºŒé‡åˆ¤å®šï¼‰
      let confPct = "";
      if (typeof st?.confidence === "number"){
        confPct = (st.confidence <= 1 ? (st.confidence*100) : st.confidence).toFixed(0) + "%";
      }

      const lineEl = document.getElementById("stage-prop-line");
      const whyEl  = document.getElementById("stage-prop-why");

      if (lineEl){
        lineEl.textContent = `LLMææ¡ˆ: ${from} â†’ ${to}` + (confPct ? `ï¼ˆç¢ºåº¦ ${confPct}ï¼‰` : "");
      }
      if (whyEl){
        const rationale = (st?.rationale || "").trim();
        whyEl.textContent = rationale ? rationale : "ï¼ˆä¼šè©±å†…å®¹ã‹ã‚‰è‡ªå‹•åˆ¤æ–­ï¼‰";
      }

      // ã‚»ãƒ¬ã‚¯ãƒˆã¯å¸¸ã« state.stageSelected ã‚’å„ªå…ˆï¼ˆrun/refine æ™‚ã«æ—¢ã«åŒæœŸï¼‰
      const sel = document.getElementById("sel-stage");
      if (sel && sel.value !== state.stageSelected){
        sel.value = state.stageSelected;
      }
    }


    // chat
    function addUserMsg(t){ const div=document.createElement("div"); div.className="msg user"; div.textContent=t; $("#chat-box").appendChild(div); scrollChat(); }
    function addBotMsg(t){ const div=document.createElement("div"); div.className="msg bot"; div.textContent=t; $("#chat-box").appendChild(div); scrollChat(); }
    function scrollChat(){ const el=$("#chat-box"); el.scrollTop = el.scrollHeight; }

    $("#chat-send").addEventListener("click", async ()=>{
      const msg = $("#chat-input").value.trim();
      if (!msg) return;
      addUserMsg(msg);
      $("#chat-input").value = "";
      setEditLocked(true);
      try{
        // â˜… æ­£ã—ã„ API ã«ä¿®æ­£




        // Guard: meeting_id ãŒç„¡ã‘ã‚Œã°é€ã‚Œãªã„
        if (!state.meetingId){
          addBotMsg("å…ˆã«ã€è­°äº‹éŒ²ã‚’ç”Ÿæˆã€ã—ã¦ãã ã•ã„ï¼ˆmeeting_id ãŒæœªå–å¾—ã§ã™ï¼‰ã€‚");
          setEditLocked(false);
          return;
        }

        // ã‚µãƒ¼ãƒå®Ÿè£…å·®ç•°ã«å‚™ãˆã€äº’æ›ã‚­ãƒ¼ã‚’åŒæ™‚é€ä¿¡
        const payload = {
          meeting_id: state.meetingId,
          user_instruction: msg,   // å®Ÿè£…A
          instruction: msg,        // å®Ÿè£…B
          minutes_md: $("#minutes-preview").value || state.minutes_draft || "",
          selected_stage: state.stageSelected || state.ctx.prev_stage || "å•†è«‡"
        };

        // ã¾ãšã¯ /refine_chatã€å¤±æ•—ã—ãŸã‚‰ /refine ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        let res;
        try{
          res = await api.postJSON("/api/minutes/refine_chat", payload);
        }catch(_){
          res = await api.postJSON("/api/minutes/refine", payload);
        }

        const out = res.data || res;



        if (out.minutes_draft) state.minutes_draft = out.minutes_draft;
        if (out.manager_report_draft) state.manager_report = out.manager_report_draft;
        if (Array.isArray(out.risks)) state.risks = out.risks;

        // â˜… è¿½åŠ ï¼šã‚³ãƒ¼ãƒãƒ³ã‚°æ–‡ã®æ›´æ–°ï¼ˆã‚µãƒ¼ãƒãŒè¿”ã›ã°åæ˜ ï¼‰
        if (out.coach_feedback) state.coach_feedback = out.coach_feedback;

        if (state.minutesStep === "analysis") renderPhaseTips();

        if (out.suggested_changes?.stage?.to){
          const to = coerceToValidStage(out.suggested_changes.stage.to, state.stageSelected || state.ctx.prev_stage);
          state.stageSelected = to;
          $("#sel-stage").value = to;
        }
        $("#minutes-preview").value = state.minutes_draft;
        renderStageProposal();   // â˜… è¿½åŠ ï¼šæœ€æ–°ã®ææ¡ˆå†…å®¹ã«æ›´æ–°

        renderStageEvidence();  //æ—¢å­˜ã®ã‚„ã¤ã€‚
        addBotMsg("æ›´æ–°ã—ã¾ã—ãŸã€‚å³å´ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åæ˜ æ¸ˆã¿ã§ã™ã€‚");
      }catch(e){
        addBotMsg("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
      }finally{
        setEditLocked(false);
      }
    });

    function setEditLocked(locked){
      $("#lock-edit").classList.toggle("show", locked);
      $("#chat-input").disabled = locked;
      $("#chat-send").disabled = locked;
      $("#sel-stage").disabled = locked;
      $("#minutes-preview").disabled = locked;
      $("#btn-save-minutes").disabled = locked;
    }

    // stage change
    $("#sel-stage").addEventListener("change", ()=> state.stageSelected = $("#sel-stage").value);

    // save minutes ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼
    $("#btn-save-minutes").addEventListener("click", async ()=>{
      state.minutes_draft = $("#minutes-preview").value;
      setEditLocked(true);
      try{
        // ãƒ©ãƒ™ãƒ«ã¯ infer.suggested_changes.labels_add ã‚’è‡ªå‹•é©ç”¨
        const labels = state.infer?.suggested_changes?.labels_add || [];

        const res = await api.postJSON("/api/minutes/save_final", {
          meeting_id: state.meetingId,
          minutes_md: state.minutes_draft,
          selected_stage: state.stageSelected,
          labels
        });

        // âœ… Wordï¼ˆ.docxï¼‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ä¿å­˜å¾Œã«è¡¨ç¤º
        const docx = $("#btn-download-docx");
        if (docx){
          if (res.docx_url){
            docx.href = res.docx_url;
            docx.style.display = "inline-block";
          }else{
            docx.style.display = "none";
          }
        }

        // âœ… å•†è«‡åˆ†æã¸é€²ã‚€ãƒœã‚¿ãƒ³ã¯ä¿å­˜å¾Œã«è¡¨ç¤º
        const go = $("#btn-go-analysis");
        if (go) go.style.display = "inline-block";

        // âœ… ã€Œä¿å­˜æ¸ˆã¿ã€ãƒãƒƒãƒ—è¡¨ç¤º
        const saved = $("#chip-saved");
        if (saved) saved.style.display = "inline-flex";

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        loadDashboard();
      }catch(e){
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
      }finally{
        setEditLocked(false);
      }
    });


    // go analysis
    $("#btn-go-analysis").addEventListener("click", ()=>{
      state.minutesStep = "analysis";
      renderAnalysis();
      updateMinutesView();
    });

    function escapeHtml(s){ return (s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

    function updateMinutesView(){
    $("#min-step-input").style.display    = (state.minutesStep==="input")?"block":"none";
    $("#min-step-running").style.display  = (state.minutesStep==="running")?"block":"none";
    $("#min-step-edit").style.display     = (state.minutesStep==="edit")?"block":"none";
    $("#min-step-analysis").style.display = (state.minutesStep==="analysis")?"block":"none";

    if (state.minutesStep==="edit") {
      $("#sel-stage").value = state.stageSelected;
      $("#minutes-preview").value = state.minutes_draft;

      // ã“ã“ã§ #btn-go-analysis ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆä¿å­˜å¾Œã«ã ã‘è¡¨ç¤ºï¼‰
      //const go = $("#btn-go-analysis");
      //if (go) go.style.display = go.style.display || "none";
    }
    if (state.minutesStep==="analysis") renderAnalysis();
  }



  // back buttons
  const backToInput = document.getElementById("btn-back-to-input");
  if (backToInput){
    backToInput.addEventListener("click", ()=>{
      state.minutesStep="input";
      updateMinutesView();
    });
  }
  const backToEdit = document.getElementById("btn-back-to-edit");
  if (backToEdit){
    backToEdit.addEventListener("click", ()=>{
      state.minutesStep="edit";
      updateMinutesView();
    });
  }

    // -------------------- analysis --------------------
    function renderAnalysis(){
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        $$(".tab[data-ana-tab]").forEach(tab=>{
            tab.onclick = ()=>{
                $$(".tab[data-ana-tab]").forEach(t=>t.classList.remove("active"));
                tab.classList.add("active");
                const key = tab.dataset.anaTab;
                $("#ana-tab-risks").style.display = (key==="risks") ? "block" : "none";
                $("#ana-tab-coach").style.display = (key==="coach") ? "block" : "none";
            };
        });

        // ä¸Šå¸ã¸ã®å ±å‘Š
        $("#manager-report").textContent = state.manager_report || "ï¼ˆä¸Šå¸å‘ã‘ã®ç°¡æ½”ãªå ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰";

        const willAddWarn = (state.infer?.suggested_changes?.labels_add || []).includes("è¦æ³¨æ„");
        document.getElementById("risk-label-suggest").style.display = willAddWarn ? "inline-flex" : "none";


        // ãƒªã‚¹ã‚¯ä¸€è¦§
        const rl = $("#risk-list");
        rl.innerHTML = (state.risks||[]).map((r)=>`
            <div style="border:1px solid var(--border);border-radius:10px;padding:.75rem;margin-bottom:.6rem">
                <div><b>[${r.severity||""}] ${r.category||""}</b></div>
                ${r.context_summary? `<div style="margin-top:.4rem"><i>å…¨ä½“è¦ç´„:</i> ${escapeHtml(r.context_summary)}</div>`:""}
                ${r.evidence_span? `<pre style="white-space:pre-wrap;background:#f9fafb;border:1px solid var(--border);padding:.5rem;border-radius:8px;margin-top:.5rem">${escapeHtml(r.evidence_span)}</pre>`:""}
                ${r.action? `<div style="margin-top:.4rem"><i>æ¨å¥¨å¯¾å¿œ:</i> ${escapeHtml(r.action)}</div>`:""}
            </div>
        `).join("");

        // ä¼šè©±ãƒãƒ©ãƒ³ã‚¹ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰â€”è©±è€…åˆ¤å®šã‚’å …ç‰¢åŒ–
        let bank = 0, client = 0;
        const bankName = (state.ctx.owner_bank || "").trim();

        for (const t of (state.turns || [])){
            const text = (t.text || "").replace(/\s+/g,"");
            const len  = [...text].length;

            const name  = (t.speaker_name || t.speaker || t.speaker_label || "").trim();
            const label = (t.speaker_label || "").toLowerCase();

            // å„ªå…ˆåº¦ï¼šlabel â†’ æ˜ç¤ºåä¸€è‡´ â†’ å«æ„èªåˆ¤å®š
            const isBankByLabel =
                ["bank","sales","seller","agent","banker","å–¶æ¥­","éŠ€è¡Œ"].some(k => label.includes(k));

            const isBankByName  =
                bankName && name && (name === bankName);

            const isBankByHint  =
                /éŠ€è¡Œ|å–¶æ¥­|æ‹…å½“|bank|sales/i.test(name);

            const isBank = isBankByLabel || isBankByName || isBankByHint;

            if (isBank) bank += len; else client += len;
        }

        let total = bank + client;
        // å…¨ã‚¼ãƒ­ã®ã¨ãã¯è¦‹æ „ãˆå„ªå…ˆã§ 50/50 ã«
        if (!total){ bank = 1; client = 1; total = 2; }

        const bankRatio   = bank / total * 100;
        const clientRatio = 100 - bankRatio;

        Plotly.newPlot("pie", [{
            type:"pie",
            labels:["é¡§å®¢","å–¶æ¥­æ‹…å½“"],
            values:[clientRatio, bankRatio],
            hole:.3,
            textinfo:"none",
            textposition: "outside",
            // â˜… è¿½åŠ ï¼šå°‘æ•°1æ¡ã§çµ±ä¸€ã€æ³¨é‡ˆéè¡¨ç¤º
            hovertemplate: "%{label}: %{value:.1f}%<extra></extra>",
            texttemplate: "%{label}<br>%{value:.1f}%"
        }], {
          margin: {t: 10, b: 10, l: 40, r: 40},
          height: 300,
          showlegend: false                          // å‡¡ä¾‹ã¯ä¸è¦ãªã‚‰éè¡¨ç¤º
        }, { displayModeBar: false });

        // ä¼šè©±ãƒãƒ©ãƒ³ã‚¹ã«é–¢ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿è¡¨ç¤º
        const coach = $("#coach-msg");
        if (bankRatio <= 40){
          coach.innerHTML = `âœ”ï¸ <b>ç†æƒ³çš„ãªä¼šè©±ãƒãƒ©ãƒ³ã‚¹ã§ã™ã€‚</b>ï¼ˆå–¶æ¥­ ${bankRatio.toFixed(1)}%ï¼‰ é¡§å®¢ã®è©±ã‚’ååˆ†ã«å¼•ãå‡ºã›ã¦ã„ã¾ã™ã€‚`;
        }else{
          coach.innerHTML = `âš ï¸ <b>å–¶æ¥­å´ã®ç™ºè©±ãŒã‚„ã‚„å¤šã‚ã§ã™ã€‚</b>ï¼ˆå–¶æ¥­ ${bankRatio.toFixed(1)}%ï¼‰ æ¬¡å›ã¯ã‚ªãƒ¼ãƒ—ãƒ³è³ªå•ã‚’å¢—ã‚„ã—ã€é¡§å®¢ãŒè©±ã™æ™‚é–“ã‚’ç¢ºä¿ã—ã¾ã—ã‚‡ã†ã€‚`;
        }

// ãƒ•ã‚§ãƒ¼ã‚ºã«åŸºã¥ãã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯åˆ¥æ ã¸
renderPhaseTips();

    }
    function renderPhaseTips(){
      const el = $("#phase-tips");
      if (!el) return;

      const txt = (state.coach_feedback || "").trim();
      if (txt){
        el.textContent = txt; // LLM å‡ºåŠ›ã‚’å„ªå…ˆ
        return;
      }

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰
      const from = state.ctx?.prev_stage || "å•†è«‡";
      const toRaw = state.stageSelected || from;
      const to = (toRaw === from) ? "åŒã˜" : toRaw;
      const key = `${from}â†’${to}`;

      const phaseGuidelines = {
        "å•†è«‡â†’åŒã˜": "æ„æ€æ±ºå®šè€…/è©•ä¾¡è»¸/ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®å…·ä½“åŒ–ã€‚æ¬¡å›ææ¡ˆãƒ‰ãƒ©ãƒ•ãƒˆåˆæ„ã€‚",
        "å•†è«‡â†’ææ¡ˆãƒ»æ¦‚ç®—æ¡ä»¶ã®æç¤º": "ä¾¡æ ¼ä»¥å¤–ã®æ¯”è¼ƒè»¸ã¨å¯©æŸ»å¿…è¦æ›¸é¡ã®å…ˆå‡ºã—ã€‚æ¬¡å›åˆæ„äº‹é …ã‚’æ˜ç¢ºã«ã€‚",
        "ææ¡ˆãƒ»æ¦‚ç®—æ¡ä»¶ã®æç¤ºâ†’ç”³è¾¼ãƒ»å¯©æŸ»": "å¯©æŸ»é˜»å®³è¦å› ã®å…ˆå›ã‚Šè§£æ¶ˆï¼ˆä½“åˆ¶/æ›¸é¡/ç¨Ÿè­°é †ï¼‰ã€‚",
        "ç”³è¾¼ãƒ»å¯©æŸ»â†’ç¨Ÿè­°æ›¸èªè¨¼": "ãƒªã‚¹ã‚¯ã¸ã®å¯¾æ¡ˆï¼ˆæ‹…ä¿/ä¿è¨¼/ã‚³ãƒ™ãƒŠãƒ³ãƒ„ï¼‰ã§ç¨Ÿè­°è«–ç‚¹ã‚’äº‹å‰ã«æ½°ã™ã€‚",
        "ç¨Ÿè­°æ›¸èªè¨¼â†’å¥‘ç´„æ‰‹ç¶šã": "èª°ãŒ/ã„ã¤/ä½•ã‚’ã‚µã‚¤ãƒ³ã™ã‚‹ã‹æ®µå–ã‚Šã‚’è©°ã‚ã‚‹ã€‚",
        "å¥‘ç´„æ‰‹ç¶šãâ†’èè³‡å®Ÿè¡Œ": "å®Ÿè¡Œæ¡ä»¶ã®ToDoï¼ˆç™»è¨˜/å…¥é‡‘å£åº§/æ—¥ç¨‹ï¼‰ã¨é€†ç®—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚"
      };

      el.textContent = phaseGuidelines[key] || "ï¼ˆè©²å½“ã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰";
    }



    // === æ–°ã—ã„è­°äº‹éŒ²ã‚’é–‹å§‹ï¼ˆçŠ¶æ…‹ã¨UIã®åˆæœŸåŒ–ï¼‰ ===
    function resetMinutesFlow(){
      // state åˆæœŸåŒ–
      state.minutesStep = "input";
      state.inputMode   = "text";
      state.amountMode  = "unset";
      state.ctx = {
        company:"", meeting_date:"", prev_stage:"å•†è«‡",
        owner_bank:"ç”°ä¸­çœŸå¥ˆç¾", owner_client:"", meetings_count:1, amount:null
      };
      state.meetingId = null;
      state.turns = []; state.evidence = null; state.infer = null; state.narratives = null;
      state.stageSelected = "å•†è«‡";
      state.minutes_draft = ""; state.manager_report = ""; state.risks = [];
      state.docxUrl = ""; state.pdfUrl = "";
      state.coach_feedback = ""; // â˜… è¿½åŠ ï¼šå‰å›ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã‚¯ãƒªã‚¢

      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
      $("#i-company").value = "";
      $("#i-date").value = "";
      $("#i-prev-stage").value = "å•†è«‡";
      $("#i-owner-bank").value = "ç”°ä¸­çœŸå¥ˆç¾";
      $("#i-owner-client").value = "";
      $("#i-meetings").value = "1";

      // é‡‘é¡ãƒ¢ãƒ¼ãƒ‰
      const rUnset = document.querySelector("input[name='amountMode'][value='unset']");
      const rSet   = document.querySelector("input[name='amountMode'][value='set']");
      if (rUnset) rUnset.checked = true;
      if (rSet)   rSet.checked   = false;
      $("#i-amount").style.display = "none";
      $("#i-amount").value = "";

      // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
      const rAudio = document.querySelector("input[name='inputMode'][value='audio']");
      const rText  = document.querySelector("input[name='inputMode'][value='text']");
      if (rText) rText.checked = true;
      $("#box-audio").style.display = "none";
      $("#box-text").style.display  = "block";

      // UI ãƒªã‚»ãƒƒãƒˆï¼ˆãƒœã‚¿ãƒ³ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç­‰ï¼‰
      const go   = $("#btn-go-analysis"); if (go)   go.style.display   = "none";
      const docx = $("#btn-download-docx"); if (docx) docx.style.display = "none";
      const saved= $("#chip-saved"); if (saved) saved.style.display = "none";
      $("#chat-box").innerHTML = "";
      $("#minutes-preview").value = "";
      $("#turns-pre").textContent = "ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";

      updateMinutesView();
    }

// åˆ†æç”»é¢ã®å³ä¸Šãƒœã‚¿ãƒ³
const newBtn = document.getElementById("btn-new-minutes");
if (newBtn) newBtn.addEventListener("click", resetMinutesFlow);



    // -------------------- page router --------------------
    $$(".nav-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const page = btn.dataset.page;
        setPage(page);
      });
    });

    // -------------------- performance (bars) --------------------
    async function renderPerformance(){
      const m = await api.get("/api/metrics/performance").catch(()=>null);
      if (m){
        $("#kpi-achv").textContent = (m.target_achievement_pct||104) + "%";
      }else{
        $("#kpi-achv").textContent = "104%";
      }

      const weeks = [
        "5æœˆ-1","5æœˆ-2","5æœˆ-3","5æœˆ-4",
        "6æœˆ-1","6æœˆ-2","6æœˆ-3","6æœˆ-4",
        "7æœˆ-1","7æœˆ-2","7æœˆ-3","7æœˆ-4",
        "8æœˆ-1","8æœˆ-2","8æœˆ-3","8æœˆ-4"
      ];
      const val = [44,51,47,60, 55,49,52,46, 57,61,53,48, 59,54,62,50];
      const target = 50;

      const trace = {
        type:'bar',
        x: weeks,
        y: val,
        marker:{color: getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || 'rgba(59,130,246,0.55)'}
      };
      const layout = {
        margin:{t:10,r:10,b:40,l:40},
        shapes: [{
          type:'line', x0:-0.5, x1:weeks.length-0.5, y0:target, y1:target,
          line:{color:'#9CA3AF', width:1, dash:'dot'}
        }],
        yaxis:{title:'ä»¶æ•°'},
        xaxis:{tickangle:-30}
      };
      Plotly.newPlot('weekly-bars',[trace],layout,{displayModeBar:false});
    }

    // -------------------- init --------------------
    (async function init(){
      await loadDashboard();
      // ãƒ‡ãƒ•ã‚©ã§ performance KPI ä¸€åº¦æç”»ï¼ˆå€¤ã¯å›ºå®šï¼‹APIçµæœï¼‰
      renderPerformance();
    })();
  </script>
</body>
</html>
